<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Calculator</title>
  <!-- Link to CSS -->
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="calculator-styles.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

</head>
<body>
<!-- Header -->
  <div hx-get="modules/header.html" hx-trigger="load"></div>

<!-- Main Content Container -->
<main class="main-content-wrapper">

<!-- Modal Backdrop -->
<div class="modal-backdrop" id="modalBackdrop"></div>

<!-- Modal Form -->
<div class="modal-container" id="formSection">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Product</h2>
            <button class="modal-close" id="btnCloseForm">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="modal-form-grid">
                <!-- SECTION 1: Product Input -->
                <div class="calculator-card">
                    <h3>1. Execution Data</h3>
                    <div class="form-row">
                        <div class="form-group flex-2">
                            <label for="productName">Project</label>
                            <input type="text" id="productName" placeholder="Ex: Bear" class="form-input">
                        </div>
                        <div class="form-group flex-1">
                            <label for="productColor">Colors</label>
                            <div class="color-input-wrapper">
                                <input type="text" id="productColor" placeholder="Ex: White" class="form-input color-input">
                                <button type="button" id="btnAddColor" class="btn-secondary btn-add-color">+</button>
                            </div>
                            <div id="colorsList" class="colors-list"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group flex-2">
                            <label for="yarnType">Yarn</label>
                            <!-- This will later come from the stock database -->
                            <select id="yarnType" class="form-input" data-input="yarn-type">
                                <option value="baby-snuggle">Baby Snuggle Solid</option>
                                <option value="honey-bunny">Honey Bunny</option>
                                <option value="rainbow-cotton">Rainbow Cotton 8/8</option>
                            </select>
                        </div>
                        <div class="form-group flex-1">
                            <label for="totalWeight">Total (g)</label>
                            <input type="number" id="totalWeight" class="form-input" data-input="weight-total" value="0" step="1">
                        </div>
                        <div class="form-group flex-1">
                            <label for="yarnWeight">Yarn (g)</label>
                            <input type="number" id="yarnWeight" class="form-input" data-input="weight-yarn" value="0" step="1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label for="hook">Hook</label>
                            <input type="text" id="hook" class="form-input" value="4 mm">
                        </div>
                        <div class="form-group flex-1">
                            <label for="hours">Time (h)</label>
                            <input type="number" id="hours" class="form-input" data-input="time-hours" value="1" step="0.5">
                        </div>
                    </div>

                    <div class="extras-section">
                        <label>Extras</label>
                        <div id="extrasContainer"></div>
                        <button class="btn-secondary" id="btnAddExtra">+ Add Extras</button>
                    </div>
                </div>

                <!-- SECTION 2: Cost Analysis -->
                <div class="calculator-card">
                    <h3>2. Detailed Cost Analysis</h3>
                    
                    <div class="cost-summary">
                        <div class="cost-column">
                            <p class="cost-item">
                                <span>Yarn Cost: <small>(Normal)</small></span>
                                <strong id="yarnCostNormal">0.00â‚¬</strong>
                            </p>
                            <p class="cost-item">
                                <span>Yarn Cost: <small>(Promo)</small></span>
                                <strong id="yarnCostPromo">0.00â‚¬</strong>
                            </p>
                            <p class="cost-item">
                                <span>Filling:</span>
                                <strong id="fillingCost">0.00â‚¬</strong>
                            </p>
                        </div>
                        <div class="cost-column">
                            <p class="cost-item">
                                <span>Labor:</span>
                                <strong id="laborCost">0.00â‚¬</strong>
                            </p>
                            <p class="cost-item">
                                <span>Extras:</span>
                                <strong id="extrasCost">0.00â‚¬</strong>
                            </p>
                            <hr>
                            <p class="cost-item cost-total">
                                <span>Total: <small>(Normal)</small></span>
                                <strong id="totalNormal">0.00â‚¬</strong>
                            </p>
                            <p class="cost-item cost-total-promo">
                                <span>Total: <small>(Promo)</small></span>
                                <strong id="totalPromo">0.00â‚¬</strong>
                            </p>
                        </div>
                    </div>

                    <div class="markup-section">
                        <label>Markups</label>
                        <div class="markup-grid">
                            <button class="markup-item" data-markup="1.10">
                                <small>+10 %</small>
                                <span class="markup-val" id="m10">0â‚¬</span>
                            </button>
                            <button class="markup-item" data-markup="1.25">
                                <small>+25 %</small>
                                <span class="markup-val" id="m25">0â‚¬</span>
                            </button>
                            <button class="markup-item" data-markup="1.50">
                                <small>+50 %</small>
                                <span class="markup-val" id="m50">0â‚¬</span>
                            </button>
                            <button class="markup-item" data-markup="2.00">
                                <small>+100 %</small>
                                <span class="markup-val" id="m100">0â‚¬</span>
                            </button>
                        </div>
                    </div>

                    <div class="sale-section">
                        <div class="form-group">
                            <label for="salePrice">Final Price (â‚¬)</label>
                            <input type="number" id="salePrice" class="form-input" data-input="sale-price" value="0" step="0.01">
                        </div>

                        <div class="profit-boxes">
                            <div class="profit-box profit-promo">
                                <small>PROFIT PROMO</small>
                                <strong id="profitPromo">0.00â‚¬</strong>
                            </div>
                            <div class="profit-box profit-normal">
                                <small>PROFIT NORMAL</small>
                                <strong id="profitNormal">0.00â‚¬</strong>
                            </div>
                        </div>

                        <button class="btn-primary" id="btnSave">SAVE</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Page Content -->
<div class="container calculator-container">
    <h1 class="page-title">ðŸ§¶ Cost & Inventory Control</h1>

    <!-- Floating Action Button -->
    <button class="btn-fab" id="btnToggleForm" title="Add Product"><i class="fa-solid fa-square-plus"></i></button>

    <!-- Products Table -->
    <div class="table-section">
        <h3>Created Products</h3>
        
        <!-- Filters -->
        <div class="filters-container">
            <div class="filter-group">
                <label>Product:</label>
                <input type="text" id="filterProduct" class="filter-input" placeholder="Filter by name...">
            </div>
            <div class="filter-group">
                <label>Colour:</label>
                <select id="filterColor" class="filter-input" aria-label="Filter by colour">
                    <option value="">All Colours</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Yarn:</label>
                <select id="filterYarn" class="filter-input" aria-label="Filter by yarn">
                    <option value="">All Yarns</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Hook:</label>
                <select id="filterHook" class="filter-input" aria-label="Filter by hook">
                    <option value="">All Hooks</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Inventory:</label>
                <select id="filterStock" class="filter-input" aria-label="Filter by inventory">
                    <option value="">All</option>
                    <option value="0">Out of stock</option>
                    <option value="1+">In stock</option>
                </select>
            </div>
            <button class="btn-reset" id="btnResetFilters">Clear Filters</button>
        </div>

        <div class="table-container">
            <table id="productsTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Yarn Used</th>
                        <th>Colours & Hooks</th>
                        <th>â‚¬ Cost</th>
                        <th>â‚¬ Sale / % Profit</th>
                        <th>Inventory</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { init, appState, recalculate, addColorToList, deleteProduct } from '../js/modules/calculator-ui.js';

    // Expose to global scope for inline handlers
    window.deleteProduct = deleteProduct;
    window.recalculate = recalculate;
    window.appState = appState;
    window.addColorToList = addColorToList;

    // Start app
    init();

// Tirar isto daqui depois de testar
</script>

<!-- Load navigation tags -->
<script type="module">
    import('../js/modules/api.js').then(async (api) => {
        try {
            const pins = await api.loadPins();
            
            // Extract unique tags from pins
            const uniqueTags = [...new Set(pins.flatMap(pin => pin.tags || []))].sort();
            let colorMap = {};
            if (uniqueTags.length > 0) {
                const { generateColorsForTags } = await import('../js/modules/helper.js');
                colorMap = generateColorsForTags(uniqueTags);
            }

            // Generate dynamic nav tags
            const navTagsContainer = document.getElementById('nav-tags');
            if (navTagsContainer) {
                navTagsContainer.innerHTML = ''; // Clear existing content
                uniqueTags.forEach(tag => {
                    const bgColor = colorMap[tag];
                    const tagLink = document.createElement('a');
                    tagLink.href = `#category-${tag}`;
                    tagLink.className = 'nav-tag';
                    tagLink.style.backgroundColor = bgColor;
                    tagLink.style.color = '#333';
                    tagLink.textContent = tag;
                    navTagsContainer.appendChild(tagLink);
                });
            }
        } catch (error) {
            console.error('Error loading navigation tags:', error);
        }
    }).catch(error => console.error('Error loading api module:', error));
</script>

</main>
</body>
</html>
